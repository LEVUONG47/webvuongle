//Ophus was here
<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Giám sát IoT - Dashboard Cao Cấp</title>
        <!-- Firebase SDK -->
        <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
      import { getDatabase } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
      import { getAuth } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
      window.firebase = { initializeApp, getDatabase, getAuth };
    </script>
        <script
            src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
            rel="stylesheet">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
        :root {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4cc9f0;
            --danger: #ef233c;
            --warning: #f8961e;
            --background: #0a0a0a;
            --card-bg: #161616;
            --glass-bg: rgba(22, 22, 22, 0.7);
            --text: #f8f9fa;
            --text-secondary: #adb5bd;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            --transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            --border-radius: 16px;
            --gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
        }

        [data-theme="light"] {
            --primary: #4361ee;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --background: #f8f9fa;
            --card-bg: #ffffff;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --text: #212529;
            --text-secondary: #495057;
            --shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            position: relative;
            transition: var(--transition);
        }

        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0a0a0a, #161616);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px 30px;
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            backdrop-filter: blur(12px);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: var(--gradient);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: white;
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.5);
            transition: var(--transition);
        }

        .logo:hover {
            transform: rotate(15deg) scale(1.1);
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(to right, #4361ee, #4cc9f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .theme-toggle {
            background: var(--glass-bg);
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 22px;
            color: var(--text);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
            transform: rotate(20deg) scale(1.1);
            box-shadow: 0 0 20px rgba(67, 97, 238, 0.5);
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 20px;
            background: var(--glass-bg);
            border-radius: 30px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .status-indicator {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background-color: #adb5bd;
            transition: var(--transition);
            position: relative;
        }

        .status-indicator.connected {
            background-color: var(--success);
            box-shadow: 0 0 15px var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(76, 201, 240, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 201, 240, 0); }
        }

        .status-text {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .last-update {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 30px;
            text-align: center;
            letter-spacing: 0.5px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: var(--gradient);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
        }

        .card-title[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 10;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            font-size: 22px;
            transition: var(--transition);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(67, 97, 238, 0.1);
        }

        .card:hover .card-icon {
            transform: rotate(10deg) scale(1.1);
            background: rgba(67, 97, 238, 0.2);
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.3);
        }

        .card-value {
            font-size: 52px;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }

        .temperature .card-value { 
            background: linear-gradient(to right, #f72585, #ef233c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .humidity .card-value { 
            background: linear-gradient(to right, #4361ee, #4cc9f0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .motor .card-value { 
            font-size: 42px;
            background: linear-gradient(to right, #7209b7, #3a0ca3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card-unit {
            font-size: 16px;
            color: var(--text-secondary);
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .card-trend {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 15px;
            margin-top: 15px;
        }

        .trend-up { color: var(--accent); }
        .trend-down { color: var(--success); }
        .trend-neutral { color: var(--text-secondary); }

        .chart-section {
            margin-bottom: 40px;
        }

        .main-chart-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            height: 500px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .main-chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .chart-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        .control-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .weather-icon {
            font-size: 80px;
            text-align: center;
            margin: 20px 0;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: var(--transition);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .weather-details {
            display: flex;
            justify-content: space-around;
            font-size: 15px;
            margin-top: 15px;
            color: var(--text-secondary);
        }

        .weather-details span {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .weather-details span b {
            color: var(--text);
            font-size: 18px;
        }

        .motor-control {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .status-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(22, 22, 22, 0.5);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .led-indicator {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 15px;
            transition: var(--transition);
            position: relative;
        }

        .led-indicator.on {
            background-color: var(--success);
            box-shadow: 0 0 20px var(--success);
        }

        .led-indicator.off {
            background-color: var(--danger);
            box-shadow: 0 0 20px var(--danger);
        }

        .led-indicator::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            opacity: 0;
            transition: var(--transition);
        }

        .led-indicator.on::after {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .led-indicator.off::after {
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-label {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .status-label span {
            color: var(--text);
            font-weight: 600;
            margin-left: 5px;
        }

        .mode-selector {
            display: flex;
            background: var(--glass-bg);
            border-radius: 30px;
            padding: 8px;
            margin-top: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mode-option {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .mode-option.active {
            background: var(--gradient);
            color: white;
            box-shadow: 0 0 15px rgba(67, 97, 238, 0.5);
        }

        .control-btn {
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-on {
            background: var(--success);
            color: white;
        }

        .btn-off {
            background: var(--danger);
            color: white;
        }

        .control-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn i {
            font-size: 18px;
        }

        .last-change {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 15px;
            text-align: center;
        }

        .history-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }

        .history-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 25px;
            letter-spacing: 1px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            font-size: 15px;
            color: var(--text-secondary);
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .history-table td {
            font-size: 14px;
            color: var(--text);
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .history-table tr:hover td {
            background: rgba(255, 255, 255, 0.03);
            color: var(--primary);
        }

        .footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            font-size: 14px;
            text-align: center;
            letter-spacing: 1px;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
            transition: var(--transition);
        }

        .footer a:hover {
            color: var(--accent);
            text-decoration: underline;
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            background: var(--card-bg);
            padding: 18px 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            font-size: 15px;
            color: var(--text);
            z-index: 1000;
            opacity: 0;
            transform: translateY(-30px);
            transition: var(--transition);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification i {
            font-size: 20px;
        }

        .notification.success i { color: var(--success); }
        .notification.error i { color: var(--danger); }
        .notification.warning i { color: var(--warning); }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease;
            gap: 20px;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(67, 97, 238, 0.2);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            font-size: 18px;
            color: var(--text);
            letter-spacing: 1px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 600;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard, .control-section {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-left {
                flex-direction: column;
            }
            
            .connection-status {
                margin-top: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .card-value {
                font-size: 42px;
            }
            
            .main-chart-container {
                height: 400px;
                padding: 20px;
            }
        }
    </style>
    </head>
    <body>
        <div id="particles-js"></div>
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
            <div class="loading-text">Đang kết nối hệ thống...</div>
        </div>
        <div class="notification" id="notification"></div>
        <div class="container">
            <header>
                <div class="header-left">
                    <div class="logo">IoT</div>
                    <h1>BẢNG ĐIỀU KHIỂN THÔNG MINH</h1>
                </div>
                <div class="connection-status">
                    <div class="status-indicator" id="connectionStatus"></div>
                    <span class="status-text" id="statusText">Đang kết nối...</span>
                    <button class="theme-toggle" id="themeToggle"><i
                            class="fas fa-moon"></i></button>
                </div>
            </header>

            <div class="last-update" id="lastUpdate">Cập nhật lần cuối: --/--/---- --:--:--</div>

            <div class="dashboard">
                <div class="card temperature">
                    <div class="card-header">
                        <span class="card-title"
                            data-tooltip="Nhiệt độ hiện tại">Nhiệt độ</span>
                        <div class="card-icon">
                            <i class="fas fa-thermometer-half"></i>
                        </div>
                    </div>
                    <div class="card-value" id="temperature">--</div>
                    <div class="card-unit">°C</div>
                    <div class="card-trend">
                        <span id="tempTrend">--</span>
                        <span id="tempTrendIcon">→</span>
                    </div>
                </div>

                <div class="card humidity">
                    <div class="card-header">
                        <span class="card-title"
                            data-tooltip="Độ ẩm hiện tại">Độ ẩm</span>
                        <div class="card-icon">
                            <i class="fas fa-tint"></i>
                        </div>
                    </div>
                    <div class="card-value" id="humidity">--</div>
                    <div class="card-unit">%</div>
                    <div class="card-trend">
                        <span id="humidTrend">--</span>
                        <span id="humidTrendIcon">→</span>
                    </div>
                </div>

                <div class="card motor">
                    <div class="card-header">
                        <span class="card-title"
                            data-tooltip="Trạng thái động cơ 1">Động cơ 1</span>
                        <div class="card-icon">
                            <i class="fas fa-cog"></i>
                        </div>
                    </div>
                    <div class="mode-selector" id="relay1ModeSelector">
                        <div class="mode-option active" data-mode="auto">Tự động</div>
                        <div class="mode-option" data-mode="manual">Thủ công</div>
                    </div>
                    <div class="status-container">
                        <div class="led-indicator off" id="motor1Led"></div>
                        <span class="status-label">Trạng thái: <span
                                id="motor1StatusText">TẮT</span></span>
                    </div>
                    <div class="last-change" id="motor1LastChange">Lần cuối: --/--/---- --:--:--</div>
                    <div id="relay1ManualControl" style="display: none;">
                        <button class="control-btn btn-on"
                            id="relay1OnBtn"><i class="fas fa-power-off"></i> BẬT</button>
                        <button class="control-btn btn-off"
                            id="relay1OffBtn"><i class="fas fa-power-off"></i> TẮT</button>
                    </div>
                </div>

                <div class="card motor">
                    <div class="card-header">
                        <span class="card-title"
                            data-tooltip="Trạng thái động cơ 2">Động cơ 2</span>
                        <div class="card-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                    </div>
                    <div class="mode-selector" id="relay2ModeSelector">
                        <div class="mode-option active" data-mode="auto">Tự động</div>
                        <div class="mode-option" data-mode="manual">Thủ công</div>
                    </div>
                    <div class="status-container">
                        <div class="led-indicator off" id="motor2Led"></div>
                        <span class="status-label">Trạng thái: <span
                                id="motor2StatusText">TẮT</span></span>
                    </div>
                    <div class="last-change" id="motor2LastChange">Lần cuối: --/--/---- --:--:--</div>
                    <div id="relay2ManualControl" style="display: none;">
                        <button class="control-btn btn-on"
                            id="relay2OnBtn"><i class="fas fa-power-off"></i> BẬT</button>
                        <button class="control-btn btn-off"
                            id="relay2OffBtn"><i class="fas fa-power-off"></i> TẮT</button>
                    </div>
                </div>
            </div>

            <div class="chart-section">
                <div class="main-chart-container">
                    <div class="chart-title">Biểu đồ Nhiệt độ & Độ ẩm</div>
                    <canvas id="sensorChart"></canvas>
                </div>
            </div>

            <div class="control-section">
                <div class="card weather">
                    <div class="card-header">
                        <span class="card-title"
                            data-tooltip="Thời tiết hiện tại">Thời tiết</span>
                        <div class="card-icon">
                            <i class="fas fa-cloud-sun"></i>
                        </div>
                    </div>
                    <div class="weather-icon" id="weatherIcon">
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="card-value" id="weatherStatus">--</div>
                    <div class="weather-details">
                        <span><i class="fas fa-temperature-high"></i> <b id="weatherTemp">--</b>°C</span>
                        <span><i class="fas fa-tint"></i> <b id="weatherHumid">--</b>%</span>
                    </div>
                    <div class="last-change" id="weatherLastUpdate">Cập nhật: --/--/---- --:--:--</div>
                </div>

                <div class="card weather">
                    <div class="card-header">
                        <span class="card-title" data-tooltip="Dự báo mưa">Dự báo mưa</span>
                        <div class="card-icon">
                            <i class="fas fa-cloud-rain"></i>
                        </div>
                    </div>
                    <div class="weather-icon" id="rainIcon">
                        <i class="fas fa-question"></i>
                    </div>
                    <div class="card-value" id="rainForecast">--</div>
                    <div class="weather-details">
                        <span><i class="fas fa-tint"></i> <b id="currentHumidity">--</b>%</span>
                        <span><i class="fas fa-percentage"></i> <b id="rainProbability">--</b>%</span>
                    </div>
                    <div class="last-change" id="rainLastUpdate">Cập nhật: --/--/---- --:--:--</div>
                </div>
            </div>

            <div class="history-section">
                <div class="history-title">Lịch sử thao tác</div>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Thời gian</th>
                            <th>Thao tác</th>
                            <th>Giá trị</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable"></tbody>
                </table>
            </div>

            <div class="footer">
                <p>© 2025 HỆ THỐNG GIÁM SÁT THÔNG MINH | Thiết kế bởi <a href="#">LÊ THANH VƯƠNG</a></p>
            </div>
        </div>

        <script type="module">
            // Import các hàm cần thiết từ SDK
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
            import { getDatabase, ref, onValue, set, push, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
            import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';
            
            const firebaseConfig = {
                apiKey: "AIzaSyBWZE9Ip1cHoletCu7p6vqNz9NOAOQ1l9s",
                authDomain: "webvuongle.firebaseapp.com",
                databaseURL: "https://webvuongle-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "webvuongle",
                storageBucket: "webvuongle.appspot.com",
                messagingSenderId: "72756137917",
                appId: "1:72756137917:web:c67f01f04c4f18a520ccd4"
            };

            // Khởi tạo Firebase
            const app = initializeApp(firebaseConfig);
            const database = getDatabase(app);
            const auth = getAuth(app);
            
            // Initialize Particles.js
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: '#4361ee' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: true },
                    size: { value: 4, random: true },
                    line_linked: { enable: false },
                    move: { 
                        enable: true, 
                        speed: 2, 
                        direction: 'none', 
                        random: true,
                        out_mode: 'out'
                    }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { 
                        onhover: { enable: true, mode: 'repulse' }, 
                        onclick: { enable: true, mode: 'push' } 
                    }
                },
                retina_detect: true
            });

            // Theme toggle
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                if (currentTheme === 'light') {
                    document.documentElement.removeAttribute('data-theme');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            });

            // Loading overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            function hideLoadingOverlay() {
                loadingOverlay.classList.add('hidden');
                setTimeout(() => loadingOverlay.style.display = 'none', 500);
            }

            // Notification
            const notification = document.getElementById('notification');
            function showNotification(message, type = 'success') {
                notification.innerHTML = '';
                
                let icon;
                if (type === 'success') {
                    icon = '<i class="fas fa-check-circle"></i>';
                    notification.className = 'notification success';
                } else if (type === 'error') {
                    icon = '<i class="fas fa-exclamation-circle"></i>';
                    notification.className = 'notification error';
                } else {
                    icon = '<i class="fas fa-info-circle"></i>';
                    notification.className = 'notification warning';
                }
                
                notification.innerHTML = `${icon}<span>${message}</span>`;
                notification.classList.add('show');
                setTimeout(() => notification.classList.remove('show'), 3000);
            }

            // Chart initialization
            const chartData = {
                labels: [],
                temperature: [],
                humidity: []
            };

            const ctx = document.getElementById('sensorChart').getContext('2d');
            const sensorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        {
                            label: 'Nhiệt độ (°C)',
                            data: chartData.temperature,
                            borderColor: '#f72585',
                            backgroundColor: 'rgba(247, 37, 133, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#f72585'
                        },
                        {
                            label: 'Độ ẩm (%)',
                            data: chartData.humidity,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderWidth: 3,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4361ee'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: '#f8f9fa', 
                                font: { size: 14 },
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            } 
                        },
                        tooltip: { 
                            backgroundColor: 'rgba(22, 22, 22, 0.9)', 
                            padding: 15,
                            titleFont: { size: 16 },
                            bodyFont: { size: 14 },
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            cornerRadius: 12,
                            displayColors: true,
                            usePointStyle: true
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: false, 
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }, 
                            ticks: { color: '#adb5bd' } 
                        },
                        x: { 
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }, 
                            ticks: { color: '#adb5bd' } 
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            setInterval(() => sensorChart.update(), 5000);

            // Authentication
            let prevTemperature = null;
            let prevHumidity = null;
            let prevMotor1Status = null;
            let prevMotor2Status = null;

            signInAnonymously(auth)
                .then(() => {
                    console.log('Đăng nhập ẩn danh thành công');
                    hideLoadingOverlay();
                    initializeRealtimeListeners();
                })
                .catch((error) => {
                    console.error('Đăng nhập ẩn danh thất bại:', error);
                    showNotification('Lỗi xác thực Firebase. Vui lòng thử lại.', 'error');
                    document.getElementById('statusText').textContent = 'Mất kết nối';
                });

            onAuthStateChanged(auth, (user) => {
                const connectionStatus = document.getElementById('connectionStatus');
                const statusText = document.getElementById('statusText');
                if (user) {
                    connectionStatus.classList.add('connected');
                    statusText.textContent = 'Đã kết nối';
                    showNotification('Kết nối Firebase thành công!', 'success');
                } else {
                    connectionStatus.classList.remove('connected');
                    statusText.textContent = 'Mất kết nối';
                    showNotification('Mất kết nối với Firebase', 'error');
                }
            });

            // Realtime listeners
            function initializeRealtimeListeners() {
                // Sensor data
                const sensorRef = ref(database, 'sensor_data');
                onValue(sensorRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        document.getElementById('temperature').textContent = data.temperature.toFixed(1);
                        document.getElementById('humidity').textContent = data.humidity.toFixed(1);

                        if (prevTemperature !== null) {
                            const tempDiff = data.temperature - prevTemperature;
                            updateTrend('temp', tempDiff);
                        }
                        if (prevHumidity !== null) {
                            const humidDiff = data.humidity - prevHumidity;
                            updateTrend('humid', humidDiff);
                        }

                        prevTemperature = data.temperature;
                        prevHumidity = data.humidity;

                        const now = new Date();
                        document.getElementById('lastUpdate').textContent = `Cập nhật lần cuối: ${formatDateTime(now)}`;

                        chartData.labels.push(formatTime(now));
                        chartData.temperature.push(data.temperature);
                        chartData.humidity.push(data.humidity);

                        if (chartData.labels.length > 20) {
                            chartData.labels.shift();
                            chartData.temperature.shift();
                            chartData.humidity.shift();
                        }

                        updateWeatherStatus(data.temperature, data.humidity);
                        updateRainForecast(data.humidity);
                    }
                }, (error) => {
                    console.error('Error reading sensor data:', error);
                    showNotification('Lỗi đọc dữ liệu cảm biến.', 'error');
                });

                // Relay 1
                const relay1Ref = ref(database, 'relays/relay1');
                onValue(relay1Ref, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const motor1Led = document.getElementById('motor1Led');
                        const motor1StatusText = document.getElementById('motor1StatusText');
                        const manualControl = document.getElementById('relay1ManualControl');

                        if (data.status) {
                            motor1Led.classList.remove('off');
                            motor1Led.classList.add('on');
                            motor1StatusText.textContent = 'BẬT';
                        } else {
                            motor1Led.classList.remove('on');
                            motor1Led.classList.add('off');
                            motor1StatusText.textContent = 'TẮT';
                        }

                        if (prevMotor1Status !== null && prevMotor1Status !== data.status) {
                            showNotification(`Động cơ 1 đã ${data.status ? 'BẬT' : 'TẮT'}`, 'success');
                        }
                        prevMotor1Status = data.status;

                        const modeOptions = document.querySelectorAll('#relay1ModeSelector .mode-option');
                        modeOptions.forEach(option => {
                            option.classList.remove('active');
                            if ((option.dataset.mode === 'auto' && !data.manual) || (option.dataset.mode === 'manual' && data.manual)) {
                                option.classList.add('active');
                            }
                        });

                        manualControl.style.display = data.manual ? 'block' : 'none';

                        if (data.timestamp) {
                            document.getElementById('motor1LastChange').textContent = `Lần cuối: ${formatDateTime(new Date(data.timestamp))}`;
                        }
                    }
                }, (error) => {
                    console.error('Error reading relay1 data:', error);
                    showNotification('Lỗi đọc dữ liệu động cơ 1.', 'error');
                });

                // Relay 2
                const relay2Ref = ref(database, 'relays/relay2');
                onValue(relay2Ref, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const motor2Led = document.getElementById('motor2Led');
                        const motor2StatusText = document.getElementById('motor2StatusText');
                        const manualControl = document.getElementById('relay2ManualControl');

                        if (data.status) {
                            motor2Led.classList.remove('off');
                            motor2Led.classList.add('on');
                            motor2StatusText.textContent = 'BẬT';
                        } else {
                            motor2Led.classList.remove('on');
                            motor2Led.classList.add('off');
                            motor2StatusText.textContent = 'TẮT';
                        }

                        if (prevMotor2Status !== null && prevMotor2Status !== data.status) {
                            showNotification(`Động cơ 2 đã ${data.status ? 'BẬT' : 'TẮT'}`, 'success');
                        }
                        prevMotor2Status = data.status;

                        const modeOptions = document.querySelectorAll('#relay2ModeSelector .mode-option');
                        modeOptions.forEach(option => {
                            option.classList.remove('active');
                            if ((option.dataset.mode === 'auto' && !data.manual) || (option.dataset.mode === 'manual' && data.manual)) {
                                option.classList.add('active');
                            }
                        });

                        manualControl.style.display = data.manual ? 'block' : 'none';

                        if (data.timestamp) {
                            document.getElementById('motor2LastChange').textContent = `Lần cuối: ${formatDateTime(new Date(data.timestamp))}`;
                        }
                    }
                }, (error) => {
                    console.error('Error reading relay2 data:', error);
                    showNotification('Lỗi đọc dữ liệu động cơ 2.', 'error');
                });

                // History
                const historyRef = ref(database, 'history');
                onValue(historyRef, (snapshot) => {
                    const historyTable = document.getElementById('historyTable');
                    historyTable.innerHTML = '';
                    const records = [];
                    snapshot.forEach((childSnapshot) => {
                        records.push({ key: childSnapshot.key, ...childSnapshot.val() });
                    });
                    // Sort by timestamp (newest first) and limit to 5
                    records.sort((a, b) => b.timestamp - a.timestamp);
                    records.slice(0, 5).forEach((action) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${formatDateTime(new Date(action.timestamp))}</td>
                            <td>${action.action}</td>
                            <td>${action.value}</td>
                        `;
                        historyTable.appendChild(row);
                    });
                }, (error) => {
                    console.error('Error reading history:', error);
                    showNotification('Lỗi đọc lịch sử thao tác.', 'error');
                });
            }

            // Relay control events
            document.querySelectorAll('#relay1ModeSelector .mode-option').forEach(option => {
                option.addEventListener('click', () => {
                    const mode = option.dataset.mode;
                    const isManual = mode === 'manual';
                    document.querySelectorAll('#relay1ModeSelector .mode-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    document.getElementById('relay1ManualControl').style.display = isManual ? 'block' : 'none';

                    set(ref(database, 'relays/relay1'), {
                        status: false,
                        speed: 0,
                        manual: isManual,
                        timestamp: serverTimestamp()
                    }).then(() => {
                        push(ref(database, 'history'), {
                            action: 'Thay đổi chế độ động cơ 1',
                            value: isManual ? 'Thủ công' : 'Tự động',
                            timestamp: serverTimestamp()
                        });
                        showNotification(`Động cơ 1 chuyển sang chế độ ${isManual ? 'thủ công' : 'tự động'}`, 'success');
                    }).catch((error) => {
                        console.error('Error updating relay1 mode:', error);
                        showNotification('Lỗi thay đổi chế độ động cơ 1.', 'error');
                    });
                });
            });

            document.querySelectorAll('#relay2ModeSelector .mode-option').forEach(option => {
                option.addEventListener('click', () => {
                    const mode = option.dataset.mode;
                    const isManual = mode === 'manual';
                    document.querySelectorAll('#relay2ModeSelector .mode-option').forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    document.getElementById('relay2ManualControl').style.display = isManual ? 'block' : 'none';

                    set(ref(database, 'relays/relay2'), {
                        status: false,
                        speed: 0,
                        manual: isManual,
                        timestamp: serverTimestamp()
                    }).then(() => {
                        push(ref(database, 'history'), {
                            action: 'Thay đổi chế độ động cơ 2',
                            value: isManual ? 'Thủ công' : 'Tự động',
                            timestamp: serverTimestamp()
                        });
                        showNotification(`Động cơ 2 chuyển sang chế độ ${isManual ? 'thủ công' : 'tự động'}`, 'success');
                    }).catch((error) => {
                        console.error('Error updating relay2 mode:', error);
                        showNotification('Lỗi thay đổi chế độ động cơ 2.', 'error');
                    });
                });
            });

            document.getElementById('relay1OnBtn').addEventListener('click', () => {
                set(ref(database, 'relays/relay1'), {
                    status: true,
                    speed: 100,
                    manual: true,
                    timestamp: serverTimestamp()
                }).then(() => {
                    push(ref(database, 'history'), {
                        action: 'Bật thủ công động cơ 1',
                        value: 'BẬT',
                        timestamp: serverTimestamp()
                    });
                    showNotification('Động cơ 1 đã bật', 'success');
                }).catch((error) => {
                    console.error('Error turning on relay1:', error);
                    showNotification('Lỗi bật động cơ 1.', 'error');
                });
            });

            document.getElementById('relay1OffBtn').addEventListener('click', () => {
                set(ref(database, 'relays/relay1'), {
                    status: false,
                    speed: 0,
                    manual: true,
                    timestamp: serverTimestamp()
                }).then(() => {
                    push(ref(database, 'history'), {
                        action: 'Tắt thủ công động cơ 1',
                        value: 'TẮT',
                        timestamp: serverTimestamp()
                    });
                    showNotification('Động cơ 1 đã tắt', 'success');
                }).catch((error) => {
                    console.error('Error turning off relay1:', error);
                    showNotification('Lỗi tắt động cơ 1.', 'error');
                });
            });

            document.getElementById('relay2OnBtn').addEventListener('click', () => {
                set(ref(database, 'relays/relay2'), {
                    status: true,
                    speed: 100,
                    manual: true,
                    timestamp: serverTimestamp()
                }).then(() => {
                    push(ref(database, 'history'), {
                        action: 'Bật thủ công động cơ 2',
                        value: 'BẬT',
                        timestamp: serverTimestamp()
                    });
                    showNotification('Động cơ 2 đã bật', 'success');
                }).catch((error) => {
                    console.error('Error turning on relay2:', error);
                    showNotification('Lỗi bật động cơ 2.', 'error');
                });
            });

            document.getElementById('relay2OffBtn').addEventListener('click', () => {
                set(ref(database, 'relays/relay2'), {
                    status: false,
                    speed: 0,
                    manual: true,
                    timestamp: serverTimestamp()
                }).then(() => {
                    push(ref(database, 'history'), {
                        action: 'Tắt thủ công động cơ 2',
                        value: 'TẮT',
                        timestamp: serverTimestamp()
                    });
                    showNotification('Động cơ 2 đã tắt', 'success');
                }).catch((error) => {
                    console.error('Error turning off relay2:', error);
                    showNotification('Lỗi tắt động cơ 2.', 'error');
                });
            });

            // Helper functions
            function updateTrend(type, diff) {
                const trendElement = document.getElementById(`${type}Trend`);
                const trendIconElement = document.getElementById(`${type}TrendIcon`);
                const trendClass = diff > 0 ? 'trend-up' : (diff < 0 ? 'trend-down' : 'trend-neutral');
                trendElement.textContent = Math.abs(diff).toFixed(1);
                trendElement.className = trendClass;
                trendIconElement.textContent = diff > 0 ? '↑' : (diff < 0 ? '↓' : '→');
                trendIconElement.className = trendClass;
            }

            function formatDateTime(date) {
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const year = date.getFullYear();
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                const seconds = date.getSeconds().toString().padStart(2, '0');
                return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
            }

            function formatTime(date) {
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${hours}:${minutes}`;
            }

            function updateWeatherStatus(temp, humid) {
                const weatherIcon = document.getElementById('weatherIcon').firstElementChild;
                const weatherStatus = document.getElementById('weatherStatus');
                const weatherTemp = document.getElementById('weatherTemp');
                const weatherHumid = document.getElementById('weatherHumid');
                weatherTemp.textContent = temp.toFixed(1);
                weatherHumid.textContent = humid.toFixed(1);
                let icon, status;
                if (humid > 80) {
                    if (temp > 30) {
                        icon = 'fa-poo-storm';
                        status = 'NÓNG ẨM';
                    } else {
                        icon = 'fa-cloud-rain';
                        status = 'MƯA';
                    }
                } else if (temp > 30) {
                    icon = 'fa-sun';
                    status = 'NÓNG';
                } else if (temp < 15) {
                    icon = 'fa-snowflake';
                    status = 'LẠNH';
                } else {
                    icon = 'fa-cloud-sun';
                    status = 'ÔN HÒA';
                }
                weatherIcon.className = `fas ${icon}`;
                weatherStatus.textContent = status;
                document.getElementById('weatherLastUpdate').textContent = `Cập nhật: ${formatDateTime(new Date())}`;
            }

            function updateRainForecast(humidity) {
                const rainForecast = document.getElementById('rainForecast');
                const rainIcon = document.getElementById('rainIcon').firstElementChild;
                const currentHumidity = document.getElementById('currentHumidity');
                const rainProbability = document.getElementById('rainProbability');
                const rainLastUpdate = document.getElementById('rainLastUpdate');
                currentHumidity.textContent = humidity.toFixed(1);
                let forecastText = '';
                let iconClass = '';
                let probability = 0;
                if (humidity >= 80) {
                    forecastText = 'KHẢ NĂNG MƯA CAO';
                    iconClass = 'fa-cloud-rain';
                    probability = 90;
                } else if (humidity >= 60) {
                    forecastText = 'CÓ THỂ MƯA';
                    iconClass = 'fa-cloud';
                    probability = 60;
                } else {
                    forecastText = 'ÍT KHẢ NĂNG MƯA';
                    iconClass = 'fa-sun';
                    probability = 10;
                }
                rainForecast.textContent = forecastText;
                rainIcon.className = `fas ${iconClass}`;
                rainProbability.textContent = probability;
                rainLastUpdate.textContent = `Cập nhật: ${formatDateTime(new Date())}`;
            }

            // Load initial data
            window.addEventListener('load', () => setTimeout(hideLoadingOverlay, 1500));
        </script>
    </body>
</html>
